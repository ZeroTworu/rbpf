### Rust eBPF Firewall (POC)

#### Описание

Демонстрация возможности написания eBPF Firewall на Rust, оно же Proof Of Concept.

* Поддерживает `IP` `v4`/`v6`, `TCP`/`UDP`.
* Для обработки исходящих соединений используется `Classifiers`. 
* Для обработки входящих - `eXpress Data Path`.
* Логирование целиком в `userspace`.

#### Сборка и запуск

1. Установить [Rust](https://www.rust-lang.org/learn/get-started)
2. `rustup default stable`
3. `rustup toolchain add nightly`
4. `rustup component add rust-src --toolchain nightly`
5. `cargo install cargo-generate`
6. `cargo install bpf-linker`
7. `cargo install bindgen-cli`
8. `make build` - сборка проекта.
9. `make run` - запуск проекта. Если в `Makefile` изменить `RUST_LOG=info` на `RUST_LOG=debug` то будект показан весь перехватываемый траффик.


#### Описание настроек
Настройки находятся в `cobtrib/settings.yaml`.
* При запуске можно указать ключ `-c <settings path>`, по умолчанию предполагается, что настройки лежат рядом с бинарником.

`interfaces` - Сетевые интерфейсы с которыми работаем.

`input / output` соответственно отвечают за то, какой тип трафика на указанном интерфейсе обрабатываем.

#### Обработка траффика
Правила обработки траффика находятся в `contrib/rules/`
* При запуске можно указать ключ `-r <rules path>`, по умолчанию предполагается, что правила лежат в `./rules/` рядом с бинарником.

`name:` - Имя правила, ни на что не влияет, просто выводится в лог.

`tcp:` - Включает правило для TCP

`udp:`  - Включает правило для TCP
* Если оба `false` то правило не будет применятся.


`ok:` - Отдаёт в обработчик `Action::OK` и прерывает дальнейшую обработку правил. Траффик идёт дальше.

`drop:` - Отдаёт в обработчик `Action::DROP` и прерывает дальнейшую обработку правил. Траффик блокируется.

`input:` - Правило обрабатывает входящий траффик.

`output:` - Правило обрабатывает исходящий траффик. 
*  Если оба `false` то правило не будет применятся. 

`v4:` - Обрабатывать IPv4

`v6:`  - Обрабатывать IPv6
*  Если оба `false` то правило не будет применятся.

`source_addr_v4:` - Исходящий IPv4 адрес

`destination_addr_v4` - IPv4 адрес назначения.

`source_addr_v6` - Исходящий IPv6 адрес

`destination_addr_v6`- IPv6 адрес назначения.

`source_port_start` - Указание диапазона портов, порт источника с которого начинается диапазон.

`source_port_end` - Указание диапазона портов, порт источника которым заканчивается диапазон.
* Если необходимо указать конкретный порт - оба значения выставляются в этот порт.

`destination_port_start` - Указание диапазона портов, порт назначения которым заканчивается диапазон.

`destination_port_end` - Указание диапазона портов, порт назначения которым заканчивается диапазон.
* Если необходимо указать конкретный порт - оба значения выставляются в этот порт.
